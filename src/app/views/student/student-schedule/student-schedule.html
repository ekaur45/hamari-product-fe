<div class="flex flex-col h-full">
    <!-- Loading State -->
    @if(isLoading()) {
    <div class="flex items-center justify-center h-full">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-primary text-3xl mb-3"></i>
            <p class="text-gray-500 text-sm">Loading schedule...</p>
        </div>
    </div>
    } @else {
    <!-- Calendar Header -->
    <div class="flex items-center justify-between mb-3 sm:mb-4 flex-shrink-0 gap-2">
        <!-- Navigation -->
        <div class="flex items-center justify-between flex-1 bg-gray-50 rounded-lg p-1 sm:p-1.5">
            <button 
                (click)="previousMonth()"
                class="p-1 sm:p-1.5 hover:bg-white rounded transition-all active:scale-95 flex items-center justify-center min-w-[28px] sm:min-w-[32px]">
                <i class="fas fa-chevron-left text-gray-700 text-xs sm:text-sm"></i>
            </button>
            <div class="flex items-center gap-1 sm:gap-1.5 relative month-picker-container">
                <button 
                    (click)="showMonthPicker.set(!showMonthPicker()); $event.stopPropagation()"
                    class="flex items-center gap-1 sm:gap-1.5 px-1.5 sm:px-2 py-1 hover:bg-white rounded transition-all text-[10px] sm:text-xs">
                    <i class="fas fa-calendar-alt text-primary text-[10px] sm:text-xs"></i>
                    <h3 class="text-[10px] sm:text-xs font-bold text-gray-900 hidden sm:block">{{getMonthName()}}</h3>
                    <h3 class="text-[10px] font-bold text-gray-900 sm:hidden">{{getMonthName().substring(0, 3)}} {{currentMonth().getFullYear()}}</h3>
                    <i class="fas fa-chevron-down text-gray-500 text-[8px] sm:text-[10px]" [class.rotate-180]="showMonthPicker()"></i>
                </button>
                @if(showMonthPicker()) {
                <div class="absolute top-full left-0 sm:left-1/2 sm:transform sm:-translate-x-1/2 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 max-h-60 w-[180px] sm:min-w-[180px] sm:w-auto"
                     (click)="$event.stopPropagation()">
                    <div class="p-1.5">
                        <button 
                            (click)="goToToday()"
                            class="w-full text-left px-2 py-1.5 text-[10px] sm:text-xs hover:bg-gray-100 rounded transition">
                            <i class="fas fa-calendar-day mr-1.5 text-primary text-[10px] sm:text-xs"></i>Go to Today
                        </button>
                        <div class="border-t border-gray-200 my-1"></div>
                        <div class="max-h-[200px] overflow-y-auto">
                            @for(month of availableMonths(); track month.value.getTime()) {
                            <button 
                                (click)="selectMonth(month.value)"
                                class="w-full text-left px-2 py-1.5 text-[10px] sm:text-xs hover:bg-gray-100 rounded transition"
                                [class.bg-primary/10]="currentMonth().getMonth() === month.value.getMonth() && currentMonth().getFullYear() === month.value.getFullYear()">
                                {{month.label}}
                            </button>
                            }
                        </div>
                    </div>
                </div>
                }
            </div>
            <button 
                (click)="nextMonth()"
                class="p-1 sm:p-1.5 hover:bg-white rounded transition-all active:scale-95 flex items-center justify-center min-w-[28px] sm:min-w-[32px]">
                <i class="fas fa-chevron-right text-gray-700 text-xs sm:text-sm"></i>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="mb-3 flex-shrink-0 bg-white rounded-lg border border-gray-200 p-1 sm:p-2 overflow-x-auto">
        <!-- Day Headers -->
        <div class="grid grid-cols-7 gap-0.5 sm:gap-1 mb-1 min-w-[350px] sm:min-w-0">
            @for(dayName of ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; track dayName) {
            <div class="text-center text-[8px] sm:text-[9px] font-bold text-gray-600 py-0.5 sm:py-1 uppercase">
                <span class="hidden sm:inline">{{dayName}}</span>
                <span class="sm:hidden">{{dayName.substring(0, 1)}}</span>
            </div>
            }
        </div>

        <!-- Calendar Days -->
        <div class="grid grid-cols-7 gap-0.5 sm:gap-1 min-w-[350px] sm:min-w-0">
            @for(day of calendarDays(); track day.date.getTime()) {
            <button
                type="button"
                [class.opacity-30]="!day.isCurrentMonth"
                [class.bg-primary]="isDateSelected(day)"
                [class.text-white]="isDateSelected(day)"
                [class.shadow-md]="isDateSelected(day)"
                [class.scale-105]="isDateSelected(day)"
                [class.bg-blue-50]="day.hasBooking && !isDateSelected(day) && day.isCurrentMonth"
                [class.border-2]="day.hasBooking && day.isCurrentMonth"
                [class.border-blue-400]="day.hasBooking && day.isCurrentMonth && !isDateSelected(day)"
                [class.border-primary]="isDateSelected(day)"
                [class.ring-1]="day.isToday && !isDateSelected(day)"
                [class.ring-blue-400]="day.isToday && !isDateSelected(day)"
                [class.bg-blue-50]="day.isToday && !isDateSelected(day) && !day.hasBooking"
                [class.cursor-pointer]="day.hasBooking"
                [class.cursor-default]="!day.hasBooking"
                [class.hover:scale-105]="day.hasBooking && !isDateSelected(day)"
                [class.hover:shadow-md]="day.hasBooking && !isDateSelected(day)"
                [class.hover:border-blue-500]="day.hasBooking && !isDateSelected(day)"
                (click)="selectDate(day)"
                class="p-1 sm:p-1.5 md:p-2 rounded transition-all duration-200 flex flex-col items-start justify-start relative group min-h-[70px] sm:min-h-[90px] md:min-h-[110px] text-left">
                <!-- Day Number -->
                <span class="text-[9px] sm:text-[10px] md:text-[11px] font-bold mb-0.5 sm:mb-1" 
                      [class.text-gray-900]="!isDateSelected(day)"
                      [class.text-white]="isDateSelected(day)">
                    {{day.day}}
                </span>
                
                <!-- Booking Information -->
                @if(day.hasBooking) {
                <div class="flex flex-col gap-0.5 sm:gap-1 w-full flex-1">
                    @for(booking of day.bookings.slice(0, 1); track booking.id) {
                    <div class="text-[7px] sm:text-[8px] md:text-[10px] leading-tight"
                         [class.text-gray-700]="!isDateSelected(day)"
                         [class.text-white/90]="isDateSelected(day)">
                        <!-- Subject Name -->
                        <div class="font-bold text-[8px] sm:text-[9px] md:text-[11px] truncate mb-0.5" [title]="booking.teacherSubject.subject?.name || 'Subject'">
                            {{booking.teacherSubject.subject?.name || 'Subject'}}
                        </div>
                        <!-- Time -->
                        <div class="text-[7px] sm:text-[8px] md:text-[9px] opacity-90 font-medium">
                            {{formatTime(booking.availability.startTime)}} - {{formatTime(booking.availability.endTime)}}
                        </div>
                        <!-- Duration -->
                        <div class="text-[6px] sm:text-[7px] md:text-[8px] opacity-80 hidden sm:block">
                            {{calculateDuration(booking.availability.startTime, booking.availability.endTime)}}
                        </div>
                    </div>
                    }
                    @if(day.bookings.length > 1) {
                    <div class="text-[7px] sm:text-[8px] md:text-[9px] mt-0.5 sm:mt-1 font-semibold"
                         [class.text-gray-600]="!isDateSelected(day)"
                         [class.text-white/80]="isDateSelected(day)">
                        +{{day.bookings.length - 1}} more
                    </div>
                    }
                </div>
                }
                
                <!-- Today Indicator -->
                @if(day.isToday && !isDateSelected(day)) {
                <span class="absolute -top-0.5 -right-0.5 w-1 h-1 sm:w-1.5 sm:h-1.5 bg-blue-500 rounded-full border border-white"></span>
                }
            </button>
            }
        </div>

        <!-- Legend -->
        <div class="flex items-center justify-center gap-1.5 sm:gap-2 mt-2 pt-1.5 border-t border-gray-200 text-[7px] sm:text-[8px] md:text-[9px] flex-wrap">
            <div class="flex items-center gap-0.5 sm:gap-1">
                <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded bg-blue-50 border border-blue-400"></div>
                <span class="text-gray-600 hidden sm:inline">Has Booking</span>
                <span class="text-gray-600 sm:hidden">Booking</span>
            </div>
            <div class="flex items-center gap-0.5 sm:gap-1">
                <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded bg-primary"></div>
                <span class="text-gray-600">Selected</span>
            </div>
            <div class="flex items-center gap-0.5 sm:gap-1">
                <div class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded bg-blue-50 ring-1 ring-blue-400 relative">
                    <span class="absolute -top-0.5 -right-0.5 w-0.5 h-0.5 bg-blue-500 rounded-full"></span>
                </div>
                <span class="text-gray-600">Today</span>
            </div>
        </div>
    </div>

    }
</div>

<!-- Booking Details Dialog -->
<p-dialog 
    [(visible)]="showBookingDialog" 
    [modal]="true" 
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="w-[95vw] sm:w-full max-w-3xl"
    [breakpoints]="{'960px': '95vw', '640px': '100vw'}"
    [style]="{width: '95vw', maxWidth: '48rem'}"
    (onHide)="closeBookingDialog()">
    <ng-template pTemplate="header">
        <div class="flex items-center justify-between w-full pr-2">
            <div class="flex items-center gap-3 sm:gap-4">
                <div class="w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-primary to-primary/80 rounded-xl flex items-center justify-center text-white shadow-lg flex-shrink-0">
                    <i class="fas fa-calendar-day text-lg sm:text-xl"></i>
                </div>
                <div class="min-w-0 flex-1">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900 mb-1">
                        @if(selectedDate()) {
                            <span class="hidden sm:inline">{{selectedDate()!.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}}</span>
                            <span class="sm:hidden">{{selectedDate()!.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}}</span>
                        }
                    </h2>
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary">
                            <i class="fas fa-book-open mr-1.5 text-[10px]"></i>
                            {{selectedDateBookings().length}} class{{selectedDateBookings().length !== 1 ? 'es' : ''}}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <div class="space-y-4 sm:space-y-5 max-h-[65vh] sm:max-h-[70vh] overflow-y-auto pr-1">
        @if(selectedDateBookings().length > 0) {
            @for(booking of selectedDateBookings(); track booking.id) {
            <div class="group relative bg-white rounded-xl border-2 border-gray-100 hover:border-primary/30 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden">
                <!-- Status Indicator Bar -->
                <div class="absolute top-0 left-0 right-0 h-1"
                     [class.bg-green-500]="booking.status === 'confirmed'"
                     [class.bg-yellow-500]="booking.status === 'pending'"
                     [class.bg-red-500]="booking.status === 'cancelled'"
                     [class.bg-gray-400]="booking.status !== 'confirmed' && booking.status !== 'pending' && booking.status !== 'cancelled'">
                </div>

                <div class="p-4 sm:p-5 md:p-6">
                    <!-- Time Remaining Banner (if future booking) -->
                    @if(getTimeRemaining(booking)) {
                    <div class="mb-4 bg-gradient-to-r from-primary/10 via-primary/5 to-primary/10 rounded-xl p-3 sm:p-4 border border-primary/20 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-hourglass-half text-primary text-lg animate-pulse"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-600 mb-0.5">Time Remaining</p>
                                    <p class="font-bold text-primary text-base sm:text-lg">
                                        {{getTimeRemaining(booking)}}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    }

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Subject & Teacher Card -->
                            <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-100">
                                <div class="flex items-start gap-3">
                                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm flex-shrink-0">
                                        <i class="fas fa-book text-purple-600 text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Subject</p>
                                        <p class="font-bold text-gray-900 text-lg sm:text-xl truncate">
                                            {{booking.teacherSubject.subject?.name || 'Subject'}}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Teacher Card -->
                            <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-100">
                                <div class="flex items-start gap-3">
                                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm flex-shrink-0">
                                        <i class="fas fa-chalkboard-teacher text-blue-600 text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Teacher</p>
                                        <p class="font-bold text-gray-900 text-lg sm:text-xl truncate">
                                            {{booking.teacher.user?.firstName}} {{booking.teacher.user?.lastName}}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Time Range Card -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                                <div class="flex items-start gap-3 mb-3">
                                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm flex-shrink-0">
                                        <i class="fas fa-clock text-green-600 text-xl"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Schedule</p>
                                    </div>
                                </div>
                                <div class="space-y-2 pl-14">
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                                        <div class="flex-1">
                                            <p class="text-xs text-gray-600 mb-0.5">Starts</p>
                                            <p class="font-bold text-gray-900 text-sm sm:text-base">
                                                @if(getBookingStartDateTime(booking)) {
                                                    <span class="hidden sm:inline">{{getBookingStartDateTime(booking)!.toLocaleString('en-US', { 
                                                        weekday: 'short', 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        hour: 'numeric', 
                                                        minute: '2-digit',
                                                        hour12: true 
                                                    })}}</span>
                                                    <span class="sm:hidden">{{getBookingStartDateTime(booking)!.toLocaleString('en-US', { 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        hour: 'numeric', 
                                                        minute: '2-digit',
                                                        hour12: true 
                                                    })}}</span>
                                                } @else {
                                                    {{formatTime(booking.availability.startTime)}}
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full bg-red-500"></div>
                                        <div class="flex-1">
                                            <p class="text-xs text-gray-600 mb-0.5">Ends</p>
                                            <p class="font-bold text-gray-900 text-sm sm:text-base">
                                                @if(getBookingEndDateTime(booking)) {
                                                    <span class="hidden sm:inline">{{getBookingEndDateTime(booking)!.toLocaleString('en-US', { 
                                                        weekday: 'short', 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        hour: 'numeric', 
                                                        minute: '2-digit',
                                                        hour12: true 
                                                    })}}</span>
                                                    <span class="sm:hidden">{{getBookingEndDateTime(booking)!.toLocaleString('en-US', { 
                                                        month: 'short', 
                                                        day: 'numeric',
                                                        hour: 'numeric', 
                                                        minute: '2-digit',
                                                        hour12: true 
                                                    })}}</span>
                                                } @else {
                                                    {{formatTime(booking.availability.endTime)}}
                                                }
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Duration & Status Card -->
                            <div class="bg-gradient-to-br from-primary/5 to-primary/10 rounded-xl p-4 border border-primary/20">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm">
                                            <i class="fas fa-hourglass text-primary text-lg"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-0.5">Duration</p>
                                            <p class="font-bold text-gray-900 text-base sm:text-lg">
                                                {{calculateDuration(booking.availability.startTime, booking.availability.endTime)}}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="pt-3 border-t border-primary/20">
                                    <div class="flex items-center justify-between">
                                        <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold shadow-sm"
                                              [class.bg-green-100]="booking.status === 'confirmed'"
                                              [class.text-green-700]="booking.status === 'confirmed'"
                                              [class.bg-yellow-100]="booking.status === 'pending'"
                                              [class.text-yellow-700]="booking.status === 'pending'"
                                              [class.bg-red-100]="booking.status === 'cancelled'"
                                              [class.text-red-700]="booking.status === 'cancelled'"
                                              [class.bg-gray-100]="booking.status !== 'confirmed' && booking.status !== 'pending' && booking.status !== 'cancelled'"
                                              [class.text-gray-700]="booking.status !== 'confirmed' && booking.status !== 'pending' && booking.status !== 'cancelled'">
                                            <i class="fas fa-info-circle mr-1.5"></i>
                                            {{booking.status | titlecase}}
                                        </span>
                                        @if(booking.totalAmount && booking.totalAmount > 0) {
                                        <div class="flex items-center gap-2 px-3 py-1.5 bg-white rounded-lg shadow-sm">
                                            <i class="fas fa-dollar-sign text-primary"></i>
                                            <span class="font-bold text-gray-900 text-sm sm:text-base">
                                                <span class="text-gray-600">{{booking.paidAmount || 0}}</span>
                                                <span class="mx-1">/</span>
                                                <span>{{booking.totalAmount}}</span>
                                            </span>
                                        </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            }
        } @else {
        <div class="flex items-center justify-center py-16 sm:py-20">
            <div class="text-center max-w-md">
                <div class="w-20 h-20 sm:w-24 sm:h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-calendar-times text-gray-300 text-4xl sm:text-5xl"></i>
                </div>
                <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2">No bookings scheduled</h3>
                <p class="text-sm sm:text-base text-gray-500">This day doesn't have any scheduled classes</p>
            </div>
        </div>
        }
    </div>
</p-dialog>